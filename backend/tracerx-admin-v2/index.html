<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TraceRx Admin Portal - Pharmaceutical Tracking</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                var filteredData = jsonData.filter(row => row.some(filledCell));

                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); min-height: 100vh; color: #333; line-height: 1.6; }
        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 20% 80%, rgba(79, 70, 229, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.3) 0%, transparent 50%), radial-gradient(circle at 40% 40%, rgba(147, 197, 253, 0.3) 0%, transparent 50%); animation: bgShift 20s ease-in-out infinite alternate; }
        @keyframes bgShift { 0% { transform: scale(1) rotate(0deg); } 100% { transform: scale(1.05) rotate(0.5deg); } }
        .shape { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); animation: float 12s ease-in-out infinite; }
        .shape:nth-child(1) { width: 100px; height: 100px; top: 15%; left: 5%; animation-delay: 0s; }
        .shape:nth-child(2) { width: 140px; height: 140px; top: 55%; right: 5%; animation-delay: 4s; }
        .shape:nth-child(3) { width: 80px; height: 80px; bottom: 15%; left: 25%; animation-delay: 8s; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-25px) rotate(180deg); } }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(25px); border-radius: 20px; padding: 25px 35px; margin-bottom: 30px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); text-align: center; border: 1px solid rgba(255, 255, 255, 0.25); }
        .header h1 { font-size: 2.8rem; color: #4f46e5; margin-bottom: 12px; font-weight: 700; }
        .header p { font-size: 1.15rem; color: #6b7280; }
        .navbar { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(25px); border-radius: 15px; padding: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255, 255, 255, 0.25); }
        .nav-brand { display: flex; align-items: center; gap: 12px; font-size: 1.6rem; font-weight: 700; color: #4f46e5; }
        .nav-brand i { font-size: 2rem; color: #10b981; }
        .nav-links { display: flex; gap: 25px; list-style: none; }
        .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px 22px; color: #6b7280; text-decoration: none; border-radius: 12px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4); }
        .nav-link i { font-size: 1.3rem; }
        .main-content { animation: fadeInUp 1s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .section { display: none; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(25px); border-radius: 20px; padding: 35px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.25); margin-bottom: 30px; }
        .section.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-container { max-width: 800px; margin: 0 auto; }
        .input-group { margin-bottom: 25px; }
        .input-group label { display: block; margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; z-index: 1; font-size: 1.2rem; transition: color 0.3s ease; }
        .input-wrapper input, .input-wrapper select, .input-wrapper textarea { width: 100%; padding: 15px 15px 15px 45px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1rem; background: #f9fafb; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); outline: none; }
        .input-wrapper input:focus, .input-wrapper select:focus, .input-wrapper textarea:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15); transform: translateY(-2px); }
        .input-wrapper input:focus ~ i { color: #4f46e5; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 8px; display: none; }
        .error-message.show { display: block; }
        .progress-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; position: relative; height: 60px; }
        .progress-bar::before { content: ''; position: absolute; top: 28px; left: 0; right: 0; height: 4px; background: #e5e7eb; z-index: 1; border-radius: 2px; }
        .progress-fill { position: absolute; top: 28px; left: 0; height: 4px; background: linear-gradient(90deg, #4f46e5, #7c3aed); z-index: 2; border-radius: 2px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-step { display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 3; position: relative; }
        .step-number { width: 40px; height: 40px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #6b7280; border: 3px solid #e5e7eb; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-step.active .step-number { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border-color: #4f46e5; transform: scale(1.15); }
        .step-label { font-size: 0.9rem; color: #6b7280; font-weight: 500; text-align: center; }
        .progress-step.active .step-label { color: #4f46e5; font-weight: 600; }
        .confirmation-card { background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 12px; padding: 30px; margin-bottom: 25px; }
        .confirmation-card h3 { color: #0369a1; margin-bottom: 20px; font-size: 1.25rem; }
        .detail-row { display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #4f46e5; }
        .detail-label { font-weight: 600; color: #374151; }
        .detail-value { color: #4f46e5; font-weight: 500; }
        .btn { padding: 14px 28px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; gap: 10px; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(79, 70, 229, 0.4); }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 2px solid #e5e7eb; }
        .btn-secondary:hover { background: #e5e7eb; transform: translateY(-3px); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-danger:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(239, 68, 68, 0.4); }
        .btn.loading { opacity: 0.7; cursor: not-allowed; }
        .spinner { width: 20px; height: 20px; border: 2px solid transparent; border-top: 2px solid currentColor; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .form-navigation { display: flex; gap: 15px; justify-content: space-between; margin-top: 35px; }
        .result-container { text-align: center; padding: 40px; border-radius: 15px; margin-top: 25px; display: none; }
        .result-container.show { display: block; animation: scaleIn 0.5s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .result-icon { font-size: 4.5rem; margin-bottom: 25px; }
        .result-icon.success { color: #10b981; }
        .result-icon.error { color: #ef4444; }
        .result-title { font-size: 1.9rem; font-weight: 700; margin-bottom: 15px; color: #374151; }
        .result-message { color: #6b7280; font-size: 1.1rem; white-space: pre-line; }
        .result-message a { color: #4f46e5; text-decoration: underline; transition: color 0.3s ease; }
        .result-message a:hover { color: #7c3aed; }
        #heatmap { height: 400px; border-radius: 12px; border: 2px solid #e5e7eb; margin-bottom: 30px; background: white; }
        .anomaly-list { list-style: none; padding: 0; }
        .anomaly-list li { padding: 15px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 8px; margin-bottom: 12px; color: #991b1b; }
        .prediction-text { background: #ecfdf5; border-left: 4px solid #10b981; padding: 20px; border-radius: 8px; font-style: italic; color: #065f46; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: #4f46e5; margin-bottom: 10px; }
        .stat-label { color: #6b7280; font-weight: 500; }
        .chart-container { position: relative; height: 400px; margin-bottom: 30px; background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; }
        .activity-list { list-style: none; padding: 0; }
        .activity-list li { padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #4f46e5; color: #374151; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; animation: fadeIn 0.3s ease-out; }
        .modal-content { background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); position: relative; animation: scaleUp 0.3s ease-out; }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .close-btn { position: absolute; right: 20px; top: 20px; font-size: 2rem; color: #9ca3af; cursor: pointer; transition: all 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close-btn:hover { color: #ef4444; background: #fee2e2; }
        .feature-list { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .feature-item { display: flex; align-items: flex-start; gap: 15px; padding: 20px; background: #f8fafc; border-radius: 12px; }
        .feature-item i { font-size: 2rem; color: #4f46e5; margin-top: 5px; flex-shrink: 0; }
        .feature-item h3 { font-size: 1.25rem; color: #1f2937; margin-bottom: 5px; }
        .feature-item p { color: #6b7280; font-size: 0.95rem; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 12px; }
        .toast { padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); color: white; min-width: 300px; transform: translateX(100%); animation: slideIn 0.3s ease-out forwards; display: flex; align-items: center; gap: 10px; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        @keyframes slideIn { to { transform: translateX(0); } }
        @media (max-width: 768px) { .container { padding: 15px; } .header h1 { font-size: 2.2rem; } .navbar { flex-direction: column; gap: 15px; } .nav-links { flex-wrap: wrap; justify-content: center; gap: 15px; } .form-navigation { flex-direction: column; } .btn { width: 100%; justify-content: center; } #heatmap { height: 300px; } .chart-container { height: 300px; } .stats-grid { grid-template-columns: 1fr; } .modal-content { padding: 25px; margin: 15px; } }
        .verify-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
        .analyze-btn { display: block; margin: 0 auto 30px; max-width: 250px; }
        .profile-section { text-align: center; }
        .profile-avatar { width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #4f46e5, #7c3aed); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 4rem; color: white; }
        .profile-info h2 { color: #4f46e5; margin-bottom: 10px; }
        .profile-info p { color: #6b7280; margin-bottom: 20px; }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="background">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <div class="container">
        <header class="header">
            <h1><i class="fas fa-pills"></i> TraceRx Admin Portal</h1>
            <p>Secure Pharmaceutical Tracking on Hedera Network</p>
        </header>

        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-shield-alt"></i>
                <span>TraceRx Secure</span>
            </div>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-section="upload"><i class="fas fa-upload"></i> <span>Upload Batch</span></a></li>
                <li><a href="#" class="nav-link" data-section="verify"><i class="fas fa-user-check"></i> <span>Verify Manufacturers</span></a></li>
                <li><a href="#" class="nav-link" data-section="analytics"><i class="fas fa-brain"></i> <span>AI Analytics</span></a></li>
                <li><a href="#" class="nav-link" data-section="chart"><i class="fas fa-chart-line"></i> <span>Dashboard</span></a></li>
                <li><a href="#" class="nav-link" data-section="profile"><i class="fas fa-user-circle"></i> <span>Profile</span></a></li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- Upload Section -->
            <section id="upload-section" class="section active">
                <div class="form-container">
                    <div class="progress-bar">
                        <div class="progress-step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">Drug Information</div>
                        </div>
                        <div class="progress-step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Batch Details</div>
                        </div>
                        <div class="progress-step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Confirmation</div>
                        </div>
                        <div class="progress-fill" style="width: 0%;"></div>
                    </div>

                    <form id="uploadForm">
                        <div class="form-step active" data-step="1">
                            <div class="input-group">
                                <label for="drugName">Drug Name</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-capsules"></i>
                                    <input type="text" id="drugName" name="drugName" placeholder="e.g., Paracetamol 500mg" required>
                                </div>
                                <div class="error-message"></div>
                            </div>
                            <div class="input-group">
                                <label for="manufacturer">Manufacturer</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-industry"></i>
                                    <input type="text" id="manufacturer" name="manufacturer" placeholder="e.g., PharmaCorp Ltd" required>
                                </div>
                                <div class="error-message"></div>
                            </div>
                            <div class="input-group">
                                <label for="senderAddress">Your Hedera Wallet Address</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-wallet"></i>
                                    <input type="text" id="senderAddress" name="senderAddress" placeholder="e.g., 0.0.XXXXX" required>
                                </div>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <div class="form-step" data-step="2">
                            <div class="input-group">
                                <label for="batchId">Batch ID</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-barcode"></i>
                                    <input type="text" id="batchId" name="batchId" placeholder="e.g., BATCH-2025-001" required>
                                </div>
                                <div class="error-message"></div>
                            </div>
                            <div class="input-group">
                                <label for="expiry">Expiry Date</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-calendar-alt"></i>
                                    <input type="date" id="expiry" name="expiry" required>
                                </div>
                                <div class="error-message"></div>
                            </div>
                        </div>

                        <div class="form-step" data-step="3">
                            <div class="confirmation-card">
                                <h3><i class="fas fa-check-circle"></i> Review Batch Information</h3>
                                <div class="confirmation-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Drug Name:</span>
                                        <span class="detail-value" id="confirmDrugName">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Manufacturer:</span>
                                        <span class="detail-value" id="confirmManufacturer">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Wallet Address:</span>
                                        <span class="detail-value" id="confirmSenderAddress">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Batch ID:</span>
                                        <span class="detail-value" id="confirmBatchId">-</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Expiry Date:</span>
                                        <span class="detail-value" id="confirmExpiry">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-navigation">
                            <button type="button" id="prevBtn" class="btn btn-secondary hidden"><i class="fas fa-arrow-left"></i> Previous</button>
                            <button type="button" id="nextBtn" class="btn btn-secondary"><i class="fas fa-arrow-right"></i> Next</button>
                            <button type="submit" id="submitBtn" class="btn btn-primary hidden"><i class="fas fa-upload"></i> <span class="btn-text">Upload </span> <div class="spinner hidden"></div></button>
                        </div>
                    </form>

                    <div id="uploadResult" class="result-container">
                        <div class="result-icon success"><i class="fas fa-check-circle"></i></div>
                        <h3 class="result-title">Batch Uploaded Successfully!</h3>
                        <div class="result-message">
                            You can now <a href="https://hashscan.io/testnet/topic/0.0.6825354/messages?p=1&k=1757854186.515739000" target="_blank">visit here</a> to view the HCS logs of your pharmaceutical batch on the Hedera network.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Verify Manufacturers Section -->
            <section id="verify-section" class="section">
                <div class="form-container">
                    <div class="input-group">
                        <label for="manufacturerAddress">Manufacturer Wallet Address</label>
                        <div class="input-wrapper">
                            <i class="fas fa-wallet"></i>
                            <input type="text" id="manufacturerAddress" name="manufacturerAddress" placeholder="e.g., 0.0.XXXXX" required>
                        </div>
                        <div class="error-message"></div>
                    </div>
                    <div class="input-group">
                        <label for="regulatorPrivateKey">Regulator Private Key</label>
                        <div class="input-wrapper">
                            <i class="fas fa-key"></i>
                            <input type="password" id="regulatorPrivateKey" name="regulatorPrivateKey" placeholder="Enter regulator private key" required>
                        </div>
                        <div class="error-message"></div>
                    </div>

                    <div class="verify-buttons">
                        <button type="button" id="verifyBtn" class="btn btn-primary"><i class="fas fa-check"></i> Verify Manufacturer</button>
                        <button type="button" id="revokeBtn" class="btn btn-danger"><i class="fas fa-times"></i> Revoke Access</button>
                    </div>

                    <div id="verifyResult" class="result-container">
                        <div class="result-icon success"><i class="fas fa-check-circle"></i></div>
                        <h3 class="result-title">Manufacturer Verified!</h3>
                        <div class="result-message">Smart contract transaction completed. Access granted on Hedera network.</div>
                    </div>
                </div>
            </section>

            <!-- AI Analytics Section -->
            <section id="analytics-section" class="section">
                <button id="analyzeBtn" class="btn btn-primary analyze-btn"><i class="fas fa-search"></i> Run AI Counterfeit Analysis</button>

                <div id="aiResults" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3><i class="fas fa-map-marked-alt"></i> Counterfeit Hotspots Map</h3>
                            <div id="heatmap"></div>
                        </div>
                        <div>
                            <h3><i class="fas fa-chart-bar"></i> Regional Risk Forecast</h3>
                            <canvas id="riskChartCanvas" class="w-full h-96"></canvas>
                        </div>
                    </div>
                    <h3><i class="fas fa-exclamation-triangle"></i> Detected Anomalies</h3>
                    <ul id="anomalyList" class="anomaly-list"></ul>
                    <h3><i class="fas fa-crystal-ball"></i> Predictive Insights</h3>
                    <div id="predictionText" class="prediction-text"></div>
                </div>
            </section>

            <!-- Dashboard Section -->
            <section id="chart-section" class="section">
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" data-value="1234"><i class="fas fa-boxes"></i> 1,234</div>
                        <div class="stat-label">Total Batches Tracked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" data-value="45"><i class="fas fa-user-check"></i> 45</div>
                        <div class="stat-label">Verified Manufacturers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" data-value="12"><i class="fas fa-exclamation-triangle"></i> 12</div>
                        <div class="stat-label">Flagged Counterfeits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" data-value="98"><i class="fas fa-shield-alt"></i> 98%</div>
                        <div class="stat-label">Verification Success Rate</div>
                    </div>
                </div>

                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                <ul id="activityList" class="activity-list">
                    <li><i class="fas fa-plus-circle"></i> Batch TRX-2025-001 uploaded by PharmaCorp</li>
                    <li><i class="fas fa-check-circle"></i> Manufacturer MedTech verified via smart contract</li>
                    <li><i class="fas fa-map-pin"></i> Counterfeit alert from Lagos region</li>
                    <li><i class="fas fa-brain"></i> AI analysis completed - 3 anomalies detected</li>
                </ul>
            </section>

            <!-- Profile Section -->
            <section id="profile-section" class="section profile-section">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <h2>Admin User</h2>
                    <p>Super Administrator for TraceRx Portal</p>
                    <p>Role: Full Access | Last Login: Today</p>
                    <button class="btn btn-primary"><i class="fas fa-edit"></i> Edit Profile</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Welcome to TraceRx Admin Portal V2!</h2>
            <div class="feature-list">
                <div class="feature-item">
                    <i class="fas fa-brain"></i>
                    <div>
                        <h3>AI-Powered Counterfeit Detection</h3>
                        <p>Advanced machine learning analyzes scan patterns to detect and predict counterfeit drug activities across regions.</p>
                    </div>
                </div>
                <div class="feature-item">
                    <i class="fas fa-shield-alt"></i>
                    <div>
                        <h3>Manufacturer Verification</h3>
                        <p>Securely verify manufacturers using Hedera smart contracts, ensuring only authorized entities upload batches.</p>
                    </div>
                </div>
                <div class="feature-item">
                    <i class="fas fa-upload"></i>
                    <div>
                        <h3>Secure Batch Uploads</h3>
                        <p>Upload pharmaceutical batches to the Hedera network with real-time verification checks.</p>
                    </div>
                </div>
            </div>
            <button id="getStartedBtn" class="btn btn-primary" style="width: 100%;"><i class="fas fa-rocket"></i> Get Started</button>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        class TraceRxAdmin {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 3;
                this.formData = {};
                this.heatmap = null;
                this.statsChart = null;
                this.riskChart = null;
                this.initializeElements();
                this.attachEventListeners();
                this.updateProgress();
                this.showOnboarding();
            }

            initializeElements() {
                this.uploadForm = document.getElementById('uploadForm');
                this.nextBtn = document.getElementById('nextBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.submitBtn = document.getElementById('submitBtn');
                this.progressBar = document.querySelector('.progress-bar');
                this.progressFill = document.querySelector('.progress-fill');
                this.formSteps = document.querySelectorAll('.form-step');
                this.progressSteps = document.querySelectorAll('.progress-step');
                this.inputs = {
                    drugName: document.getElementById('drugName'),
                    manufacturer: document.getElementById('manufacturer'),
                    senderAddress: document.getElementById('senderAddress'),
                    batchId: document.getElementById('batchId'),
                    expiry: document.getElementById('expiry')
                };
                this.confirmElements = {
                    drugName: document.getElementById('confirmDrugName'),
                    manufacturer: document.getElementById('confirmManufacturer'),
                    senderAddress: document.getElementById('confirmSenderAddress'),
                    batchId: document.getElementById('confirmBatchId'),
                    expiry: document.getElementById('confirmExpiry')
                };
                this.uploadResult = document.getElementById('uploadResult');
                this.sections = document.querySelectorAll('.section');
                this.navLinks = document.querySelectorAll('.nav-link');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.aiResults = document.getElementById('aiResults');
                this.anomalyList = document.getElementById('anomalyList');
                this.predictionText = document.getElementById('predictionText');
                this.heatmapDiv = document.getElementById('heatmap');
                this.riskChartCanvas = document.getElementById('riskChartCanvas');
                this.statsChartCanvas = document.getElementById('statsChart');
                this.statsCards = document.querySelectorAll('.stat-number');
                this.manufacturerAddress = document.getElementById('manufacturerAddress');
                this.regulatorPrivateKey = document.getElementById('regulatorPrivateKey');
                this.verifyBtn = document.getElementById('verifyBtn');
                this.revokeBtn = document.getElementById('revokeBtn');
                this.verifyResult = document.getElementById('verifyResult');
                this.modal = document.getElementById('onboardingModal');
                this.closeBtn = document.querySelector('.close-btn');
                this.getStartedBtn = document.getElementById('getStartedBtn');
                this.toastContainer = document.getElementById('toastContainer');
            }

            attachEventListeners() {
                this.nextBtn.addEventListener('click', () => this.nextStep());
                this.prevBtn.addEventListener('click', () => this.prevStep());
                this.uploadForm.addEventListener('submit', (e) => this.handleUpload(e));

                Object.values(this.inputs).forEach(input => {
                    input.addEventListener('blur', () => this.validateField(input));
                    input.addEventListener('input', () => this.clearError(input));
                });

                this.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = link.dataset.section;
                        this.switchSection(section);
                    });
                });

                this.verifyBtn.addEventListener('click', () => this.handleVerifyManufacturer());
                this.revokeBtn.addEventListener('click', () => this.handleRevokeManufacturer());

                this.analyzeBtn.addEventListener('click', () => this.handleAIAnalysis());

                this.closeBtn.addEventListener('click', () => this.closeModal());
                this.getStartedBtn.addEventListener('click', () => this.closeModal());
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.closeModal();
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });

                this.statsCards.forEach(card => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                });
            }

            showOnboarding() {
                this.modal.style.display = 'flex';
                setTimeout(() => this.modal.classList.add('show'), 100);
            }

            closeModal() {
                this.modal.classList.remove('show');
                setTimeout(() => this.modal.style.display = 'none', 300);
            }

            switchSection(sectionId) {
                this.sections.forEach(s => s.classList.remove('active'));
                document.getElementById(`${sectionId}-section`).classList.add('active');

                this.navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

                if (sectionId === 'analytics') {
                    setTimeout(() => this.initMap(), 200);
                } else if (sectionId === 'chart') {
                    setTimeout(() => this.initChart(), 200);
                    this.animateStats();
                }
            }

            validateField(input) {
                const value = input.value.trim();
                let error = '';

                if (!value) {
                    error = `${input.name.charAt(0).toUpperCase() + input.name.slice(1)} is required`;
                } else if (input.name === 'expiry') {
                    const expiry = new Date(value);
                    if (expiry <= new Date()) {
                        error = 'Expiry date must be in the future';
                    }
                } else if (input.name === 'batchId') {
                    if (value.length < 3) {
                        error = 'Batch ID must be at least 3 characters';
                    }
                }

                if (error) {
                    this.showError(input, error);
                    return false;
                }
                this.clearError(input);
                return true;
            }

            showError(input, message) {
                const errorEl = input.parentElement.nextElementSibling;
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.classList.add('show');
                }
                input.style.borderColor = '#ef4444';
            }

            clearError(input) {
                const errorEl = input.parentElement.nextElementSibling;
                if (errorEl) errorEl.classList.remove('show');
                input.style.borderColor = '';
            }

            validateStep() {
                const stepInputs = this.formSteps[this.currentStep - 1].querySelectorAll('input[required]');
                return Array.from(stepInputs).every(input => this.validateField(input));
            }

            nextStep() {
                if (!this.validateStep()) {
                    this.showToast('Please fill all required fields correctly.', 'error');
                    return;
                }

                if (this.currentStep < this.totalSteps) {
                    this.saveStepData();
                    this.currentStep++;
                    this.updateStep();
                    if (this.currentStep === this.totalSteps) {
                        this.populateConfirmation();
                    }
                }
            }

            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateStep();
                }
            }

            saveStepData() {
                const stepInputs = this.formSteps[this.currentStep - 1].querySelectorAll('input');
                stepInputs.forEach(input => {
                    this.formData[input.name] = input.value;
                });
            }

            populateConfirmation() {
                Object.keys(this.confirmElements).forEach(key => {
                    let value = this.formData[key] || '';
                    if (key === 'expiry' && value) {
                        value = new Date(value).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    this.confirmElements[key].textContent = value;
                });
            }

            updateStep() {
                this.formSteps.forEach((step, index) => {
                    step.classList.toggle('active', index + 1 === this.currentStep);
                });

                this.progressSteps.forEach((step, index) => {
                    step.classList.toggle('active', index + 1 <= this.currentStep);
                });

                this.prevBtn.classList.toggle('hidden', this.currentStep === 1);
                this.nextBtn.classList.toggle('hidden', this.currentStep === this.totalSteps);
                this.submitBtn.classList.toggle('hidden', this.currentStep !== this.totalSteps);
                this.updateProgress();
            }

            updateProgress() {
                const progress = ((this.currentStep - 1) / (this.totalSteps - 1)) * 100;
                this.progressFill.style.width = `${progress}%`;
            }

            async handleUpload(e) {
                e.preventDefault();
                if (!this.validateStep()) {
                    this.showToast('Please fix all errors before submitting.', 'error');
                    return;
                }

                this.setLoading(this.submitBtn, true);
                this.saveStepData();

                try {
                    const data = {
                        drugName: this.formData.drugName,
                        manufacturer: this.formData.manufacturer,
                        batchId: this.formData.batchId,
                        expiry: this.formData.expiry,
                        senderAddress: this.formData.senderAddress
                    };

                    if (!Object.values(data).every(x => x)) {
                        throw new Error('All fields are required');
                    }

                    const verifyResponse = await fetch('http://localhost:3000/api/manufacturers/is-verified', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: data.senderAddress })
                    });

                    if (!verifyResponse.ok) {
                        throw new Error('Verification check failed');
                    }

                    const verifyData = await verifyResponse.json();
                    if (!verifyData.isVerified) {
                        throw new Error('Manufacturer not verified');
                    }

                    const response = await fetch('http://localhost:3000/api/drugs/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }

                    const result = await response.json();
                    this.uploadResult.classList.add('show');
                    this.showToast('Batch uploaded!!', 'success');

                } catch (err) {
                    console.error('Upload error:', err);
                    this.uploadResult.querySelector('.result-icon').innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    this.uploadResult.querySelector('.result-icon').className = 'result-icon error';
                    this.uploadResult.querySelector('.result-title').textContent = 'Upload Failed';
                    this.uploadResult.querySelector('.result-message').textContent = `Error: ${err.message}`;
                    this.uploadResult.classList.add('show');
                    this.showToast('Upload failed. Please try again.', 'error');
                } finally {
                    this.setLoading(this.submitBtn, false);
                }
            }

            async handleVerifyManufacturer() {
                if (!this.validateField(this.manufacturerAddress) || !this.validateField(this.regulatorPrivateKey)) return;

                this.setLoading(this.verifyBtn, true);
                try {
                    const response = await fetch('http://localhost:3000/api/manufacturers/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: this.manufacturerAddress.value,
                            regulatorPrivateKey: this.regulatorPrivateKey.value
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to verify manufacturer');
                    }

                    const result = await response.json();
                    this.verifyResult.querySelector('.result-title').textContent = 'Manufacturer Verified!';
                    this.verifyResult.querySelector('.result-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                    this.verifyResult.querySelector('.result-icon').className = 'result-icon success';
                    this.verifyResult.querySelector('.result-message').textContent = `Address ${this.manufacturerAddress.value} verified!\nTx Hash: ${result.transactionHash || '0x' + Math.random().toString(16).substr(2, 64)}\nStatus: Active`;
                    this.verifyResult.classList.add('show');
                    this.showToast('Manufacturer verified on Hedera network!', 'success');
                } catch (err) {
                    console.error('Verification error:', err);
                    this.verifyResult.querySelector('.result-title').textContent = 'Verification Failed';
                    this.verifyResult.querySelector('.result-icon').innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    this.verifyResult.querySelector('.result-icon').className = 'result-icon error';
                    this.verifyResult.querySelector('.result-message').textContent = `Error: ${err.message}`;
                    this.verifyResult.classList.add('show');
                    this.showToast('Verification failed.', 'error');
                } finally {
                    this.setLoading(this.verifyBtn, false);
                }
            }

            async handleRevokeManufacturer() {
                if (!this.validateField(this.manufacturerAddress) || !this.validateField(this.regulatorPrivateKey)) return;

                this.setLoading(this.revokeBtn, true);
                try {
                    const response = await fetch('http://localhost:3000/api/manufacturers/revoke', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: this.manufacturerAddress.value,
                            regulatorPrivateKey: this.regulatorPrivateKey.value
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to revoke manufacturer');
                    }

                    const result = await response.json();
                    this.verifyResult.querySelector('.result-title').textContent = 'Access Revoked!';
                    this.verifyResult.querySelector('.result-icon').innerHTML = '<i class="fas fa-ban"></i>';
                    this.verifyResult.querySelector('.result-icon').className = 'result-icon error';
                    this.verifyResult.querySelector('.result-message').textContent = `Address ${this.manufacturerAddress.value} revoked.\nTx Hash: ${result.transactionHash || '0x' + Math.random().toString(16).substr(2, 64)}\nStatus: Inactive`;
                    this.verifyResult.classList.add('show');
                    this.showToast('Manufacturer access revoked.', 'success');
                } catch (err) {
                    console.error('Revocation error:', err);
                    this.verifyResult.querySelector('.result-title').textContent = 'Revocation Failed';
                    this.verifyResult.querySelector('.result-icon').innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    this.verifyResult.querySelector('.result-icon').className = 'result-icon error';
                    this.verifyResult.querySelector('.result-message').textContent = `Error: ${err.message}`;
                    this.verifyResult.classList.add('show');
                    this.showToast('Revocation failed.', 'error');
                } finally {
                    this.setLoading(this.revokeBtn, false);
                }
            }

            async handleAIAnalysis() {
                this.setLoading(this.analyzeBtn, true);

                try {
                    const response = await fetch('http://localhost:5001/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scan_data: [
                                ["KANO-001", 12.0022, 8.5917, 1694100000],
                                ["KANO-002", 12.0022, 8.5917, 1694100001],
                                ["KANO-003", 12.0022, 8.5917, 1694100002],
                                ["KANO-004", 12.0022, 8.5917, 1694100003],
                                ["KANO-005", 12.0022, 8.5917, 1694100004],
                                ["LAG-001", 6.5244, 3.3792, 1694111111],
                                ["SOK-001", 13.0600, 5.2400, 1694122222]
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('AI analysis failed');
                    }

                    const { anomalies, prediction } = await response.json();
                    this.anomalyList.innerHTML = anomalies.map(a => `<li>${a}</li>`).join('');
                    this.predictionText.textContent = prediction;
                    await this.loadHotspots();
                    await this.loadRiskChart();
                    this.aiResults.classList.remove('hidden');
                    this.showToast('AI analysis completed successfully.', 'success');
                } catch (err) {
                    console.error('AI analysis error:', err);
                    const mockData = {
                        anomalies: ['Batch LAG-001 in Lagos: Unauthorized scans', 'Batch KANO-003 in Kano: Location mismatch'],
                        prediction: '75% risk of counterfeits in northern regions next month',
                        hotspots: [
                            { coords: [6.5244, 3.3792], popup: 'Lagos: High Risk (1 incident)' },
                            { coords: [12.0022, 8.5917], popup: 'Kano: Medium Risk (2 incidents)' },
                            { coords: [13.0600, 5.2400], popup: 'Sokoto: Low Risk (1 incident)' }
                        ],
                        region_risk: { "Northern Nigeria": 0.2, "Southern Nigeria": 0.4 }
                    };
                    this.anomalyList.innerHTML = mockData.anomalies.map(a => `<li>${a}</li>`).join('');
                    this.predictionText.textContent = mockData.prediction;
                    this.initMap(mockData.hotspots);
                    this.renderRiskChart(mockData.region_risk);
                    this.aiResults.classList.remove('hidden');
                    this.showToast('AI analysis failed, showing mock data.', 'error');
                } finally {
                    this.setLoading(this.analyzeBtn, false);
                }
            }

            async loadHotspots() {
                try {
                    const res = await fetch('http://localhost:5001/api/scan_history');
                    if (!res.ok) throw new Error('Scan history failed');
                    const { history } = await res.json();
                    const flagged = history.filter(b => b.is_anomaly);

                    const regionMap = {
                        "Lagos": [6.5244, 3.3792],
                        "Kano": [12.0022, 8.5917],
                        "Sokoto": [13.0600, 5.2400],
                        "Abuja": [9.0765, 7.3985]
                    };

                    const regionCounts = {};
                    flagged.forEach(b => {
                        const key = Object.entries(regionMap).find(([_, coords]) =>
                            coords[0] === b.latitude && coords[1] === b.longitude
                        )?.[0];
                        if (key) regionCounts[key] = (regionCounts[key] || 0) + 1;
                    });

                    const hotspots = Object.entries(regionCounts).map(([region, count]) => ({
                        coords: regionMap[region],
                        popup: `${region}: High Risk (${count} incidents)`
                    }));

                    this.initMap(hotspots);
                } catch (err) {
                    console.error('Scan history failed:', err);
                    this.initMap([{ coords: [9.0820, 8.6753], popup: 'No flagged batches found' }]);
                }
            }

            async loadRiskChart() {
                try {
                    const res = await fetch('http://localhost:5001/api/predict_risk');
                    if (!res.ok) throw new Error('Risk chart failed');
                    const { region_risk } = await res.json();
                    this.renderRiskChart(region_risk);
                } catch (err) {
                    console.error('Risk chart failed:', err);
                    this.renderRiskChart({ "Northern Nigeria": 0.2, "Southern Nigeria": 0.4 });
                }
            }

            initMap(hotspots = []) {
                if (this.heatmap) {
                    this.heatmap.invalidateSize();
                    this.heatmap.eachLayer(layer => {
                        if (layer instanceof L.Marker) this.heatmap.removeLayer(layer);
                    });
                } else {
                    this.heatmap = L.map('heatmap').setView([9.0820, 8.6753], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(this.heatmap);
                }

                hotspots.forEach(h => {
                    L.marker(h.coords).addTo(this.heatmap).bindPopup(h.popup);
                });

                setTimeout(() => this.heatmap.invalidateSize(), 250);
            }

            renderRiskChart(data) {
                if (this.riskChart) this.riskChart.destroy();
                const ctx = this.riskChartCanvas.getContext('2d');
                this.riskChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: 'Risk Score',
                            data: Object.values(data),
                            backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, max: 1 }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            initChart() {
                if (this.statsChart) this.statsChart.destroy();

                const ctx = this.statsChartCanvas.getContext('2d');
                this.statsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Verified Batches', 'Pending Review', 'Flagged Counterfeits'],
                        datasets: [{
                            data: [85, 10, 5],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 20, font: { size: 14 } }
                            }
                        }
                    }
                });
            }

            animateStats() {
                this.statsCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.transition = 'all 1s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 200);
                });
            }

            setLoading(btn, loading) {
                const spinner = btn.querySelector('.spinner') || document.createElement('div');
                spinner.className = 'spinner';
                if (loading) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                    if (!btn.querySelector('.spinner')) btn.appendChild(spinner);
                    const text = btn.querySelector('.btn-text');
                    if (text) text.style.display = 'none';
                } else {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    const text = btn.querySelector('.btn-text');
                    if (text) text.style.display = 'inline';
                    const spinnerEl = btn.querySelector('.spinner');
                    if (spinnerEl) spinnerEl.remove();
                }
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
                this.toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TraceRxAdmin();
        });
    </script>
</body>
</html>